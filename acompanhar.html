<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Acompanhar Encomenda ✨</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Cabeçalho -->
  <header class="topo-site">
    <img src="assets/logo.png" alt="Logo Lírio D. Design" class="logo" />
    <nav class="menu-principal">
      <ul>
        <li><a href="index.html">✿ Início</a></li>
        <li><a href="sobre.html">✿ Sobre</a></li>
        <li><a href="portfolio.html">✿ Portfólio</a></li>
        <li><a href="servicos.html">✿ Serviços</a></li>
        <li><a href="contato.html">✿ Contato</a></li>
      </ul>
    </nav>
  </header>

  <main class="acompanhar">
    <section class="acompanhar-container">
      <h1>Acompanhar Encomenda 💌</h1>
      <div id="input-container">
        <input type="text" id="codigo" placeholder="Digite seu código de rastreio (ex: ENCOM-123456)">
        <button onclick="buscarEncomenda()">Ver Status</button>
      </div>
      <div id="resultado" class="resultado" style="display: none;"></div>
    </section>
  </main>

  <!-- Rodapé -->
  <footer class="rodape">
    <div class="links-uteis">
      <a href="termos.html">📄 Termos e Condições</a>
      <a href="faq.html">❓ Perguntas Frequentes</a>
      <a href="politica.html">🔒 Política de Privacidade</a>
    </div>
    <p class="creditos">© 2025 Llirio Design — Todos os direitos reservados.</p>
  </footer>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://tcnonaprqfcpqmscrbkg.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjbm9uYXBycWZjcHFtc2NyYmtnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ2MzYzOTQsImV4cCI6MjA2MDIxMjM5NH0.0yyj8uPdF3C3eQGPrFBWVvHuczCnHKhnXGsbBpN96Xw'
    );

    const urlParams = new URLSearchParams(window.location.search);
    const codigoURL = urlParams.get("codigo");
    const codigoInput = document.getElementById('codigo');

    if (codigoURL) {
      document.getElementById("input-container").style.display = "none";
      buscarEncomenda(codigoURL);
    }

    function adicionarDiasUteis(data, dias) {
  const novaData = new Date(data);
  let adicionados = 0;

  while (adicionados < dias) {
    novaData.setDate(novaData.getDate() + 1);
    const diaSemana = novaData.getDay();
    if (diaSemana !== 0 && diaSemana !== 6) {
      adicionados++;
    }
  }

  return novaData;
}

function formatarData(data) {
  return data.toLocaleDateString('pt-BR', {
    day: '2-digit',
    month: 'long',
    year: 'numeric'
  });
}


async function buscarEncomenda(codigoManual) {
  const codigo = (codigoManual || codigoInput.value.trim()).toUpperCase().trim();
  const resultado = document.getElementById('resultado');
  resultado.style.display = 'block';
  resultado.innerHTML = `<p>🔎 Buscando informações para o código: <strong>${codigo}</strong>...</p>`;

  if (!codigo) {
    resultado.innerHTML = '<p class="erro">Por favor, digite o código de rastreio.</p>';
    return;
  }

  const { data: encomenda, error } = await supabase
    .from('encomendas')
    .select('*')
    .eq('codigo_rastreio', codigo)
    .single();

  if (error || !encomenda) {
    resultado.innerHTML = '<p class="erro">Nenhuma encomenda encontrada com esse código. 😢</p>';
    return;
  }

  const { data: todas } = await supabase
    .from('encomendas')
    .select('*')
    .order('data_envio', { ascending: true });

  const posicao = todas.findIndex(e => e.codigo_rastreio === codigo) + 1;
  const pendentesAntes = todas.slice(0, posicao - 1).filter(e => e.status !== 'finalizada').length;

  const diasEstimados = pendentesAntes * 3;
  const agora = new Date();
  const hora = agora.getHours();

  const inicioContagem = (hora < 12) ? agora : adicionarDiasUteis(agora, 1);
  const dataPrevista = adicionarDiasUteis(inicioContagem, diasEstimados);

  resultado.innerHTML = `
    <h2>Status da Encomenda</h2>
    <p><strong>Nome:</strong> ${encomenda.nome}</p>
    <p><strong>E-mail:</strong> ${encomenda.email}</p>
    <p><strong>Título do Livro:</strong> ${encomenda.titulo_livro}</p>
    <p><strong>Gênero:</strong> ${encomenda.genero}</p>
    <p><strong>Sinopse:</strong> ${encomenda.sinopse}</p>
    <p><strong>Referências:</strong> ${encomenda.referencias || 'Não informado'}</p>
    <p><strong>Tipo de Capa:</strong> ${encomenda.tipo_capa}</p>
    <hr>
    <p><strong>Status atual:</strong> <em>${encomenda.status}</em></p>
    <p><strong>Você está na fila:</strong> ${pendentesAntes} ${pendentesAntes === 1 ? 'encomenda' : 'encomendas'} antes da sua</p>
    <p><strong>Previsão de entrega:</strong> até <strong>${formatarData(dataPrevista)}</strong> ✨</p>
    <p class="info-final">
      ⏳ Esta é uma previsão estimada com base na fila atual. Mas não se preocupe: posso entregar sua capa antes do prazo!  
      O prazo informado é o limite máximo para entrega com carinho. 💖
    </p>
  `;

  resultado.scrollIntoView({ behavior: 'smooth' });
}

  </script>
</body>
</html>